apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: fetch-iks-cluster-config
spec:
  params:
    - name: ibmcloud-api
      description: the ibmcloud api
      default: https://cloud.ibm.com
    - name: continuous-delivery-context-secret
      description: name of the configmap containing the continuous delivery pipeline context secrets
      default: cd-secret
    - name: kubernetes-service-apikey-secret-key
      description: field in the secret that contains the api key used to login to ibmcloud kubernetes service
      default: 'API_KEY'        
    - name: resource-group
      description: target resource group (name or id) for the ibmcloud login operation
      default: ''
    - name: cluster-region
      description: (optional) the ibmcloud region hosting the cluster (if none is found it will default to the toolchain region)
      default: ''
    - name: cluster-name
      description: name of the cluster - required if no cluster pipeline resource provided to this task
      default: ""
    - name: kube-api-server-accessible
      description: |
        indicates if the kubeAPIServer is exposed which is not the case for IBM Cloud Public Shared Workers (Calico network policy).
        If 'true', the task is trying to update the Cluster Pipeline Resources definition with the appropriate informations
        When 'false', the fallback mechanism (copy file(s)) is used.
      default: 'false'
    - name: cluster-pipeline-resources-directory-fallback
      description: directory in the workspace that will be used as a fallback mechanism to store the kubeconfig file
      default: .tekton-cluster-pipeline-resources
    - name: cluster-and-worker-nodes-json-export
      description: directory in the workspace that will be used to store the cluster and worker nodes export json files
      default: ''
  resources:
    inputs:
      - name: cluster
        type: cluster
        optional: true
    outputs:
      - name: cluster
        type: cluster
        optional: true
  workspaces:
    - name: workspace
      description: A workspace backing by a volume
  steps:
    - name: setup
      image: ibmcom/pipeline-base-image:2.6
      workingDir: $(workspaces.workspace.path)
      env:
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: $(params.kubernetes-service-apikey-secret-key)
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      command: ["/bin/bash", "-c"]
      args:
        - |
          set -e -o pipefail
          ##########################################################################
          # Setting HOME explicitly to have ibmcloud plugins available
          # doing the export rather than env definition is a workaround
          # until https://github.com/tektoncd/pipeline/issues/1836 is fixed
          export HOME="/root"
          ##########################################################################
          ibmcloud config --check-version false
          if [ "$(params.cluster-region)" ]; then
            TARGET_REGION=$(params.cluster-region)
          else
            TARGET_REGION=$(jq -r '.region_id' /cd-config/toolchain.json | awk -F: '{print $3}')
          fi
          ibmcloud login -a $(params.ibmcloud-api) -r $TARGET_REGION --apikey $API_KEY
          if [ "$(params.resource-group)" ]; then
            ibmcloud target -g $(params.resource-group)
          fi
          # Look for the cluster
          if [ "$(resources.inputs.cluster.name)" == "" ]; then
            export CLUSTER_NAME="$(params.cluster-name)"
          else
            export CLUSTER_NAME="$(resources.inputs.cluster.name)"
          fi
          if ibmcloud ks cluster get --cluster $CLUSTER_NAME; then
            KUBECONFIG_FILE=$(ibmcloud ks cluster config --cluster $CLUSTER_NAME --export -s | awk -F= '{print $2}')
          else
            echo "Cluster $CLUSTER_NAME not found. Accessible clusters are:"
            ibmcloud ks clusters
            exit 1
          fi

          # PipelineResource Cluster are managed appropriately as input resources
          # but not as output resources, attempting to update the PipelineResource Cluster
          # that has been given (using kubectl patch commands)
          # Verifying the access to pipeline resources
          updateClusterPipelineResource="false"
          if [ "$(params.kube-api-server-accessible)" == "true" ]; then
            if kubectl auth can-i get pipelineresources.tekton.dev > /dev/null 2>&1; then
              updateClusterPipelineResource="true"
            fi
          fi
          if [ "$updateClusterPipelineResource" == "true" ]; then
            # TODO Need to update the Cluster Pipeline Resource with this values
            # This can only be done when TriggerTemplate#resourcetemplates will accept
            # Role and Binding K8S resources definition
            echo "TODO - Processing $KUBECONFIG_FILE"
            K8S_USER_NAME=$(yq r $KUBECONFIG_FILE users[0].name)
            K8S_USER_TOKEN=$(yq r $KUBECONFIG_FILE users[0].user.auth-provider.config.id-token)
            K8S_CLUSTER_URL=$(yq r $KUBECONFIG_FILE clusters[0].cluster.server)
            CA_PEM_FILE="$(dirname $KUBECONFIG_FILE)/$(yq r $KUBECONFIG_FILE clusters[0].cluster.certificate-authority)"
            K8S_CLUSTER_CADATA=$(base64 -w0 $CA_PEM_FILE)
            echo "K8S_USER_NAME=$K8S_USER_NAME"
            #echo "K8S_USER_TOKEN=$K8S_USER_TOKEN"
            echo "K8S_CLUSTER_URL=$K8S_CLUSTER_URL"
            #echo "K8S_CLUSTER_CADATA=$K8S_CLUSTER_CADATA"
          else
            echo "Access to pipelineresources.tekton.dev is required to update Cluser Pipeline Resource accordingly"
            echo "Falling back to copy of $(basename $KUBECONFIG_FILE) to the pipeline run volume"
            mkdir -p $(workspaces.workspace.path)/$(params.cluster-pipeline-resources-directory-fallback)/$CLUSTER_NAME
            cp $(dirname $KUBECONFIG_FILE)/$(yq r $KUBECONFIG_FILE clusters[0].cluster.certificate-authority) $(workspaces.workspace.path)/$(params.cluster-pipeline-resources-directory-fallback)/$CLUSTER_NAME
            cp $KUBECONFIG_FILE $(workspaces.workspace.path)/$(params.cluster-pipeline-resources-directory-fallback)/$CLUSTER_NAME/kubeconfig
            echo "Kubeconfig file(s) copied to $(workspaces.workspace.path)/$(params.cluster-pipeline-resources-directory-fallback)/$CLUSTER_NAME"
          fi
          if [ "$(params.cluster-and-worker-nodes-json-export)" ]; then
            mkdir -p $(workspaces.workspace.path)/$(params.cluster-and-worker-nodes-json-export)/$CLUSTER_NAME
            ibmcloud ks cluster get --cluster $CLUSTER_NAME --json > $(workspaces.workspace.path)/$(params.cluster-and-worker-nodes-json-export)/$CLUSTER_NAME/$CLUSTER_NAME.json
            ibmcloud ks worker ls --cluster $CLUSTER_NAME --json > $(workspaces.workspace.path)/$(params.cluster-and-worker-nodes-json-export)/$CLUSTER_NAME/$CLUSTER_NAME-workers.json
          fi
      volumeMounts:
        - mountPath: /cd-config
          name: cd-config-volume
  volumes:
    - name: cd-config-volume
      configMap:
        name: toolchain
        items:
        - key: toolchain.json
          path: toolchain.json